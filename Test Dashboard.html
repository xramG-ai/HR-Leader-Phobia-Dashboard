<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>HR: Leader Phobia Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root { --card-h: 380px; --bg:#0f0f10; --panel:#17181a; --text:#fff; --muted:#9aa0a6; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif}

  /* 상단바 */
  .topbar{position:sticky;top:0;z-index:50;display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:linear-gradient(#0f0f10,#0f0f1000)}
  .brand{font-weight:800;font-size:22px}
  .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border:0;border-radius:8px;background:#2b2f36;cursor:pointer}
  .icon-btn:hover{background:#39404a}
  .icon-btn svg{width:20px;height:20px;fill:#fff}

  /* 탭 패널(흰색 창) */
  .tab-panel{position:fixed;right:16px;top:56px;z-index:60;width:240px;background:#fff;color:#111;border:1px solid #d0d3d8;border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,.35);padding:12px;display:none}
  .tab-close{position:absolute;right:10px;top:8px;font-size:18px;cursor:pointer;color:#666}
  .tab-row{display:flex;gap:8px}
  .tab-btn{flex:1;padding:10px 0;border-radius:8px;border:1px solid #111;cursor:pointer;background:#000;color:#fff;font-weight:700}
  .tab-btn.active{background:#e74c3c;border-color:#e74c3c;color:#fff}
  .hint{margin-top:10px;font-size:12px;color:#555}

  /* 페이지 컨테이너 */
  .page{display:none;padding:18px}
  .page.active{display:block}
  .page-title{font-weight:800;font-size:20px;margin:0 0 12px 0}

  /* 1페이지 레이아웃: 상단 3, 하단 Q4|Q5|빈칸 */
  .grid5{display:grid;grid-template-columns:repeat(3,1fr);grid-auto-rows:var(--card-h);gap:18px}
  .card{background:var(--panel);border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,.35);padding:12px;display:flex;flex-direction:column;overflow:hidden}
  .ghost{background:transparent;box-shadow:none;border:1px dashed #2a2d32}
  .title{font-size:15px;font-weight:700;margin:2px 0 8px 2px}
  canvas{flex:1;min-height:0;width:100% !important;height:100% !important;display:block}

  /* 2페이지 보고서 */
  .toolbar{display:flex;gap:10px;align-items:center;margin-bottom:12px}
  .file{background:#2b2f36;color:#fff;border:0;border-radius:8px;padding:8px 10px}
  .btn{background:#2b2f36;color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn:hover{background:#39404a}
  .report{background:var(--panel);border-radius:12px;padding:16px;min-height:260px;line-height:1.6}

  /* 3페이지 부록 + 자물쇠 */
  .appendix{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px}
  #lock3{margin-left:8px;vertical-align:middle;font-size:22px;cursor:pointer}
  #popup{display:none;position:fixed;right:20px;bottom:60px;width:360px;background:#1b1c20;border:1px solid #2c2f35;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.5);padding:14px;z-index:65}
  #popup h3{margin:0 0 10px;font-size:16px}
  .ctrl, input[type=file]{width:100%;margin:6px 0;padding:10px;border-radius:8px;border:0;background:#2b2f36;color:#fff;cursor:pointer}
  .ctrl:hover{background:#39404a}

  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border:1px solid #2a2d32;padding:6px 8px;text-align:left}
  th{background:#1f2125}
  .muted{color:#9aa0a6}
</style>
</head>
<body>
  <!-- 상단바 -->
  <div class="topbar">
    <div class="brand">HR: Leader Phobia Dashboard</div>
    <button id="tabTrigger" class="icon-btn" aria-label="탭">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 7h8l2 3h8v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z"/></svg>
    </button>
  </div>

  <!-- 탭 패널 -->
  <div id="tabPanel" class="tab-panel">
    <div class="tab-close" onclick="toggleTabPanel()">✖</div>
    <div class="tab-row">
      <button class="tab-btn active" data-tab="1">1</button>
      <button class="tab-btn" data-tab="2">2</button>
      <button class="tab-btn" data-tab="3">3</button>
    </div>
    <div class="hint">현재 페이지는 <b id="tabHint">1번</b> 탭입니다.</div>
  </div>

  <!-- 1. 대시보드 -->
  <div id="view1" class="page active">
    <div class="grid5">
      <div class="card" style="grid-column:1"><div class="title">Q1. 리더가 된다면 가장 걱정되는 부분은?</div><canvas id="q1"></canvas></div>
      <div class="card" style="grid-column:2"><div class="title">Q2. 선호하는 팀원의 유형은?</div><canvas id="q2"></canvas></div>
      <div class="card" style="grid-column:3"><div class="title">Q3. 이상적인 팀 구성은?</div><canvas id="q3"></canvas></div>
      <div class="card" style="grid-column:1"><div class="title">Q4. 팀플로 성장했다고 느끼는 부분은?</div><canvas id="q4"></canvas></div>
      <div class="card" style="grid-column:2"><div class="title">Q5. 연령대</div><canvas id="q5"></canvas></div>
      <div class="card ghost" style="grid-column:3"></div> <!-- 빈칸 -->
    </div>
  </div>

  <!-- 2. 보고서 -->
  <div id="view2" class="page">
    <div class="page-title">보고서</div>
    <div class="toolbar">
      <input id="txt" type="file" accept=".txt" class="file" />
      <button class="btn" onclick="applyTxt()">TXT 반영</button>
    </div>
    <div id="report" class="report">TXT를 업로드하고 [TXT 반영]을 누르세요.</div>
  </div>

  <!-- 3. 부록 -->
  <div id="view3" class="page">
    <div class="page-title">부록
      <span id="lock3" title="데이터 관리">🔒</span>
    </div>
    <div class="appendix">
      <div class="card">
        <div class="title">Q1 값=1 항목</div>
        <div id="apx_q1" class="muted">없음</div>
      </div>
      <div class="card">
        <div class="title">Q4 상위 5 외</div>
        <div id="apx_q4" class="muted">없음</div>
      </div>
      <div class="card">
        <div class="title">미사용/미매핑 Q·답변</div>
        <div id="apx_unused" class="muted">없음</div>
      </div>
    </div>
  </div>

  <!-- CSV 업로드 모달(3페이지만) -->
  <div id="popup">
    <h3>데이터 관리</h3>
    <input type="file" id="csv" accept=".csv" />
    <button class="ctrl" onclick="handleCSV()">데이터 업데이트 반영</button>
    <button class="ctrl" onclick="applyCharts(true)">적용</button>
    <button class="ctrl" onclick="closePopup()">닫기</button>
  </div>

<script>
Chart.register(ChartDataLabels);

/* 탭 제어 */
function toggleTabPanel(){ const p=document.getElementById('tabPanel'); p.style.display=p.style.display==='block'?'none':'block'; }
document.getElementById('tabTrigger').addEventListener('click', toggleTabPanel);
function setActiveTab(n){
  document.querySelectorAll('#tabPanel .tab-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===String(n)));
  document.getElementById('tabHint').textContent = `${n}번`;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(`view${n}`).classList.add('active');
  document.getElementById('tabPanel').style.display='none';
}
document.querySelectorAll('#tabPanel .tab-btn').forEach(btn=>btn.addEventListener('click', e=>setActiveTab(e.currentTarget.dataset.tab)));

/* 부록 모달 */
const popup = document.getElementById('popup');
document.getElementById('lock3').addEventListener('click', ()=>popup.style.display='block');
function closePopup(){ popup.style.display='none'; }

/* 팔레트 */
const colors = ["#e74c3c","#27ae60","#f1c40f","#3498db","#9b59b6","#e67e22","#1abc9c","#f39c12","#8e44ad","#2ecc71"];

/* 데이터 상태 */
let charts = {};
let datasets = {
  // 초기 샘플
  Q1:{labels:["갈등·위기 조정 스트레스","책임감 부담","결과물 부담","복합 부담"], values:[9,6,6,2], ones:[["시간 부족",1]]},
  Q2:{labels:["주어진 일에 집중","분위기 조성 도움","주도적으로 이끔","전문성","리더십"], values:[16,12,5,5,4]},
  Q3:{labels:["균형 잡힌 팀","자율적인 팀","의사소통이 잘 되는 팀","전문가 팀","각자 역할 잘 수행"], values:[25,7,3,1,1]},
  Q4:{labels:["협업 능력","소통 능력","기술력"], values:[8,7,6], others:[["책임감",2],["창의성",1]]},
  Q5:{labels:["만 26세~30세","만 31세~35세","만 36세 이상","만 25세 이하"], values:[12,10,6,6]},
  unused: [] // [{q:"질문", items:[[답,수],...]}]
};

/* 차트 생성 */
function makeDoughnut(ctx, labels, values){
  return new Chart(ctx,{
    type:'doughnut',
    data:{labels, datasets:[{data:values, backgroundColor:colors}]},
    options:{
      responsive:true, maintainAspectRatio:false, cutout:'55%',
      plugins:{ legend:{position:'top',labels:{color:'#fff'}},
        datalabels:{color:'#fff',font:{weight:'700'},formatter:v=>v}}
    }
  });
}
function makeBarY(ctx, labels, values){
  return new Chart(ctx,{
    type:'bar',
    data:{labels, datasets:[{data:values,backgroundColor:colors}]},
    options:{
      indexAxis:'y', responsive:true, maintainAspectRatio:false,
      scales:{ x:{ticks:{display:false},grid:{color:'#2a2d32'}},
               y:{ticks:{color:'#e2e2e2'},grid:{color:'#222'}}},
      plugins:{ legend:{display:false},
        datalabels:{color:'#fff',anchor:'end',align:'right',formatter:v=>v}}
    }
  });
}
function destroyAll(){ for(const k in charts){ charts[k].destroy(); } charts={}; }
function applyCharts(showAlert=false){
  destroyAll();
  charts.q1 = makeDoughnut(document.getElementById('q1'), datasets.Q1.labels, datasets.Q1.values);
  charts.q2 = makeBarY(document.getElementById('q2'), datasets.Q2.labels, datasets.Q2.values);
  charts.q3 = makeDoughnut(document.getElementById('q3'), datasets.Q3.labels, datasets.Q3.values);
  charts.q4 = makeBarY(document.getElementById('q4'), datasets.Q4.labels, datasets.Q4.values);
  charts.q5 = makeDoughnut(document.getElementById('q5'), datasets.Q5.labels, datasets.Q5.values);
  renderAppendix();
  if(showAlert) alert("적용 완료");
}
window.addEventListener('DOMContentLoaded', ()=>applyCharts(false));

/* TXT → 보고서 */
function applyTxt(){
  const f=document.getElementById('txt').files[0];
  if(!f){ alert("TXT 파일을 선택하세요."); return; }
  const rd=new FileReader();
  rd.onload=()=> {
    const text = String(rd.result||"").trim();
    if(!text){ document.getElementById('report').textContent="빈 파일입니다."; return; }
    const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const bullets = lines.filter(l=>/^[-*•\d]+\s/.test(l));
    const paras = lines.filter(l=>!/^[-*•\d]+\s/.test(l));
    let html = "";
    if(paras.length){ html += `<p>${paras.join("</p><p>")}</p>`; }
    if(bullets.length){
      html += "<ul>";
      bullets.forEach(b=>html += `<li>${b.replace(/^[-*•\d]+\s/, "")}</li>`);
      html += "</ul>";
    }
    document.getElementById('report').innerHTML = html || "내용을 해석할 수 없습니다.";
  };
  rd.readAsText(f, 'utf-8');
}

/* CSV → 데이터셋 + 미사용/미매핑 수집 */
const COLS = {
  Q1:["Q. 리더가 된다면 가장 걱정되는 부분은?"],
  Q2:["Q. 선호하는 팀원의 유형은?"],
  Q3:["Q. 이상적인 팀 구성은?","Q. 이상적인 팀 구성은? "],
  Q4:["Q.  팀플로 성장했다고 느끼는 부분은?"],
  Q5:["Q. 연령대를 선택해주세요."]
};
const ALL_KNOWN = new Set([...COLS.Q1,...COLS.Q2,...COLS.Q3,...COLS.Q4,...COLS.Q5]);
function pickCol(row, keys){ for(const k of keys){ if (k in row) return k; } return null; }
function normalizeQ4(s){
  const t=(s||"").replace(/\s+/g,"");
  if(t.includes("협업")) return "협업 능력";
  if(t.includes("소통")) return "소통 능력";
  return s||"기타";
}
function handleCSV(){
  const f=document.getElementById('csv').files[0];
  if(!f){ alert("CSV 파일을 선택하세요."); return; }
  Papa.parse(f,{header:true,skipEmptyLines:true,complete:({data})=>{
    const map={Q1:{},Q2:{},Q3:{},Q4:{},Q5:{}, unused:{}};
    data.forEach(r=>{
      const c1=pickCol(r,COLS.Q1), c2=pickCol(r,COLS.Q2), c3=pickCol(r,COLS.Q3),
            c4=pickCol(r,COLS.Q4), c5=pickCol(r,COLS.Q5);

      if(c1 && r[c1]) map.Q1[r[c1]]=(map.Q1[r[c1]]||0)+1;
      if(c2 && r[c2]) map.Q2[r[c2]]=(map.Q2[r[c2]]||0)+1;
      if(c3 && r[c3]) map.Q3[r[c3]]=(map.Q3[r[c3]]||0)+1;
      if(c4){ const v=normalizeQ4(r[c4]); map.Q4[v]=(map.Q4[v]||0)+1; }
      if(c5 && r[c5]) map.Q5[r[c5]]=(map.Q5[r[c5]]||0)+1;

      // 미사용/미매핑 Q 수집: "Q"로 시작하지만 알려진 열이 아닌 경우
      Object.keys(r).forEach(k=>{
        const nk = k.trim();
        if (/^Q[.\s]/.test(nk) && !ALL_KNOWN.has(nk)) {
          const ans = (r[k]||"").toString().trim();
          if(!ans) return;
          map.unused[nk] = map.unused[nk] || {};
          map.unused[nk][ans] = (map.unused[nk][ans]||0)+1;
        }
      });
    });

    // Q1: 값>=2, 1은 부록
    const q1Ent=Object.entries(map.Q1||{});
    const q1Main=q1Ent.filter(([,v])=>v>=2);
    const q1Ones=q1Ent.filter(([,v])=>v===1);
    datasets.Q1={labels:q1Main.map(([k])=>k), values:q1Main.map(([,v])=>v), ones:q1Ones};

    // Q2: 상위 5
    const q2Top=Object.entries(map.Q2||{}).sort((a,b)=>b[1]-a[1]).slice(0,5);
    datasets.Q2={labels:q2Top.map(([k])=>k), values:q2Top.map(([,v])=>v)};

    // Q3: 그대로
    const q3=Object.entries(map.Q3||{});
    datasets.Q3={labels:q3.map(([k])=>k), values:q3.map(([,v])=>v)};

    // Q4: 상위 5, 나머지는 부록
    const q4Sorted=Object.entries(map.Q4||{}).sort((a,b)=>b[1]-a[1]);
    const q4Top=q4Sorted.slice(0,5);
    const q4Others=q4Sorted.slice(5);
    datasets.Q4={labels:q4Top.map(([k])=>k), values:q4Top.map(([,v])=>v), others:q4Others};

    // Q5: 그대로
    const q5=Object.entries(map.Q5||{});
    datasets.Q5={labels:q5.map(([k])=>k), values:q5.map(([,v])=>v)};

    // 미사용/미매핑
    datasets.unused = Object.entries(map.unused||{}).map(([q,ansMap])=>{
      const items = Object.entries(ansMap).sort((a,b)=>b[1]-a[1]);
      return {q, items};
    });

    alert("CSV 데이터 반영 완료. 3페이지에서 자물쇠로 '적용' 실행하세요.");
  }});
}

/* 부록 채우기 */
function renderAppendix(){
  // Q1=1
  const q1 = datasets.Q1.ones||[];
  document.getElementById('apx_q1').innerHTML = q1.length
    ? `<table><tr><th>항목</th><th>값</th></tr>${q1.map(([k,v])=>`<tr><td>${k}</td><td>${v}</td></tr>`).join("")}</table>`
    : '<span class="muted">없음</span>';

  // Q4 others
  const q4 = datasets.Q4.others||[];
  document.getElementById('apx_q4').innerHTML = q4.length
    ? `<table><tr><th>항목</th><th>값</th></tr>${q4.map(([k,v])=>`<tr><td>${k}</td><td>${v}</td></tr>`).join("")}</table>`
    : '<span class="muted">없음</span>';

  // 미사용/미매핑 Q
  const unused = datasets.unused||[];
  if(!unused.length){
    document.getElementById('apx_unused').innerHTML = '<span class="muted">없음</span>';
  }else{
    const blocks = unused.map(({q,items})=>{
      const rows = items.map(([a,c])=>`<tr><td>${a}</td><td>${c}</td></tr>`).join("");
      return `<div style="margin-bottom:10px"><div class="muted" style="margin-bottom:4px">• ${q}</div>
              <table><tr><th>답변</th><th>값</th></tr>${rows}</table></div>`;
    }).join("");
    document.getElementById('apx_unused').innerHTML = blocks;
  }
}
</script>
</body>
</html>
