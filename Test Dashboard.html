<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>HR: Leader Phobia Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  :root { --card-h: 380px; --bg:#0f0f10; --panel:#17181a; --text:#fff; --muted:#9aa0a6; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif}

  /* ìƒë‹¨ë°” */
  .topbar{position:sticky;top:0;z-index:50;display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:linear-gradient(#0f0f10,#0f0f1000)}
  .brand{font-weight:800;font-size:22px}
  .icon-btn{display:inline-flex;align-items:center;justify-content:center;width:36px;height:36px;border:0;border-radius:8px;background:#2b2f36;cursor:pointer}
  .icon-btn:hover{background:#39404a}
  .icon-btn svg{width:20px;height:20px;fill:#fff}

  /* íƒ­ íŒ¨ë„(í°ìƒ‰ ì°½) */
  .tab-panel{position:fixed;right:16px;top:56px;z-index:60;width:240px;background:#fff;color:#111;border:1px solid #d0d3d8;border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,.35);padding:12px;display:none}
  .tab-close{position:absolute;right:10px;top:8px;font-size:18px;cursor:pointer;color:#666}
  .tab-row{display:flex;gap:8px}
  .tab-btn{flex:1;padding:10px 0;border-radius:8px;border:1px solid #111;cursor:pointer;background:#000;color:#fff;font-weight:700}
  .tab-btn.active{background:#e74c3c;border-color:#e74c3c;color:#fff}
  .hint{margin-top:10px;font-size:12px;color:#555}

  /* í˜ì´ì§€ ì»¨í…Œì´ë„ˆ */
  .page{display:none;padding:18px}
  .page.active{display:block}
  .page-title{font-weight:800;font-size:20px;margin:0 0 12px 0}

  /* 1í˜ì´ì§€ ë ˆì´ì•„ì›ƒ: ìƒë‹¨ 3, í•˜ë‹¨ Q4|Q5|ë¹ˆì¹¸ */
  .grid5{display:grid;grid-template-columns:repeat(3,1fr);grid-auto-rows:var(--card-h);gap:18px}
  .card{background:var(--panel);border-radius:12px;box-shadow:0 2px 12px rgba(0,0,0,.35);padding:12px;display:flex;flex-direction:column;overflow:hidden}
  .ghost{background:transparent;box-shadow:none;border:1px dashed #2a2d32}
  .title{font-size:15px;font-weight:700;margin:2px 0 8px 2px}
  canvas{flex:1;min-height:0;width:100% !important;height:100% !important;display:block}

  /* 2í˜ì´ì§€ ë³´ê³ ì„œ */
  .toolbar{display:flex;gap:10px;align-items:center;margin-bottom:12px}
  .file{background:#2b2f36;color:#fff;border:0;border-radius:8px;padding:8px 10px}
  .btn{background:#2b2f36;color:#fff;border:0;border-radius:8px;padding:8px 12px;cursor:pointer}
  .btn:hover{background:#39404a}
  .report{background:var(--panel);border-radius:12px;padding:16px;min-height:260px;line-height:1.6}

  /* 3í˜ì´ì§€ ë¶€ë¡ + ìë¬¼ì‡  */
  .appendix{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px}
  #lock3{margin-left:8px;vertical-align:middle;font-size:22px;cursor:pointer}
  #popup{display:none;position:fixed;right:20px;bottom:60px;width:360px;background:#1b1c20;border:1px solid #2c2f35;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,.5);padding:14px;z-index:65}
  #popup h3{margin:0 0 10px;font-size:16px}
  .ctrl, input[type=file]{width:100%;margin:6px 0;padding:10px;border-radius:8px;border:0;background:#2b2f36;color:#fff;cursor:pointer}
  .ctrl:hover{background:#39404a}

  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{border:1px solid #2a2d32;padding:6px 8px;text-align:left}
  th{background:#1f2125}
  .muted{color:#9aa0a6}
</style>
</head>
<body>
  <!-- ìƒë‹¨ë°” -->
  <div class="topbar">
    <div class="brand">HR: Leader Phobia Dashboard</div>
    <button id="tabTrigger" class="icon-btn" aria-label="íƒ­">
      <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M3 7h8l2 3h8v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V7z"/></svg>
    </button>
  </div>

  <!-- íƒ­ íŒ¨ë„ -->
  <div id="tabPanel" class="tab-panel">
    <div class="tab-close" onclick="toggleTabPanel()">âœ–</div>
    <div class="tab-row">
      <button class="tab-btn active" data-tab="1">1</button>
      <button class="tab-btn" data-tab="2">2</button>
      <button class="tab-btn" data-tab="3">3</button>
    </div>
    <div class="hint">í˜„ì¬ í˜ì´ì§€ëŠ” <b id="tabHint">1ë²ˆ</b> íƒ­ì…ë‹ˆë‹¤.</div>
  </div>

  <!-- 1. ëŒ€ì‹œë³´ë“œ -->
  <div id="view1" class="page active">
    <div class="grid5">
      <div class="card" style="grid-column:1"><div class="title">Q1. ë¦¬ë”ê°€ ëœë‹¤ë©´ ê°€ì¥ ê±±ì •ë˜ëŠ” ë¶€ë¶„ì€?</div><canvas id="q1"></canvas></div>
      <div class="card" style="grid-column:2"><div class="title">Q2. ì„ í˜¸í•˜ëŠ” íŒ€ì›ì˜ ìœ í˜•ì€?</div><canvas id="q2"></canvas></div>
      <div class="card" style="grid-column:3"><div class="title">Q3. ì´ìƒì ì¸ íŒ€ êµ¬ì„±ì€?</div><canvas id="q3"></canvas></div>
      <div class="card" style="grid-column:1"><div class="title">Q4. íŒ€í”Œë¡œ ì„±ì¥í–ˆë‹¤ê³  ëŠë¼ëŠ” ë¶€ë¶„ì€?</div><canvas id="q4"></canvas></div>
      <div class="card" style="grid-column:2"><div class="title">Q5. ì—°ë ¹ëŒ€</div><canvas id="q5"></canvas></div>
      <div class="card ghost" style="grid-column:3"></div> <!-- ë¹ˆì¹¸ -->
    </div>
  </div>

  <!-- 2. ë³´ê³ ì„œ -->
  <div id="view2" class="page">
    <div class="page-title">ë³´ê³ ì„œ</div>
    <div class="toolbar">
      <input id="txt" type="file" accept=".txt" class="file" />
      <button class="btn" onclick="applyTxt()">TXT ë°˜ì˜</button>
    </div>
    <div id="report" class="report">TXTë¥¼ ì—…ë¡œë“œí•˜ê³  [TXT ë°˜ì˜]ì„ ëˆ„ë¥´ì„¸ìš”.</div>
  </div>

  <!-- 3. ë¶€ë¡ -->
  <div id="view3" class="page">
    <div class="page-title">ë¶€ë¡
      <span id="lock3" title="ë°ì´í„° ê´€ë¦¬">ğŸ”’</span>
    </div>
    <div class="appendix">
      <div class="card">
        <div class="title">Q1 ê°’=1 í•­ëª©</div>
        <div id="apx_q1" class="muted">ì—†ìŒ</div>
      </div>
      <div class="card">
        <div class="title">Q4 ìƒìœ„ 5 ì™¸</div>
        <div id="apx_q4" class="muted">ì—†ìŒ</div>
      </div>
      <div class="card">
        <div class="title">ë¯¸ì‚¬ìš©/ë¯¸ë§¤í•‘ QÂ·ë‹µë³€</div>
        <div id="apx_unused" class="muted">ì—†ìŒ</div>
      </div>
    </div>
  </div>

  <!-- CSV ì—…ë¡œë“œ ëª¨ë‹¬(3í˜ì´ì§€ë§Œ) -->
  <div id="popup">
    <h3>ë°ì´í„° ê´€ë¦¬</h3>
    <input type="file" id="csv" accept=".csv" />
    <button class="ctrl" onclick="handleCSV()">ë°ì´í„° ì—…ë°ì´íŠ¸ ë°˜ì˜</button>
    <button class="ctrl" onclick="applyCharts(true)">ì ìš©</button>
    <button class="ctrl" onclick="closePopup()">ë‹«ê¸°</button>
  </div>

<script>
Chart.register(ChartDataLabels);

/* íƒ­ ì œì–´ */
function toggleTabPanel(){ const p=document.getElementById('tabPanel'); p.style.display=p.style.display==='block'?'none':'block'; }
document.getElementById('tabTrigger').addEventListener('click', toggleTabPanel);
function setActiveTab(n){
  document.querySelectorAll('#tabPanel .tab-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===String(n)));
  document.getElementById('tabHint').textContent = `${n}ë²ˆ`;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById(`view${n}`).classList.add('active');
  document.getElementById('tabPanel').style.display='none';
}
document.querySelectorAll('#tabPanel .tab-btn').forEach(btn=>btn.addEventListener('click', e=>setActiveTab(e.currentTarget.dataset.tab)));

/* ë¶€ë¡ ëª¨ë‹¬ */
const popup = document.getElementById('popup');
document.getElementById('lock3').addEventListener('click', ()=>popup.style.display='block');
function closePopup(){ popup.style.display='none'; }

/* íŒ”ë ˆíŠ¸ */
const colors = ["#e74c3c","#27ae60","#f1c40f","#3498db","#9b59b6","#e67e22","#1abc9c","#f39c12","#8e44ad","#2ecc71"];

/* ë°ì´í„° ìƒíƒœ */
let charts = {};
let datasets = {
  // ì´ˆê¸° ìƒ˜í”Œ
  Q1:{labels:["ê°ˆë“±Â·ìœ„ê¸° ì¡°ì • ìŠ¤íŠ¸ë ˆìŠ¤","ì±…ì„ê° ë¶€ë‹´","ê²°ê³¼ë¬¼ ë¶€ë‹´","ë³µí•© ë¶€ë‹´"], values:[9,6,6,2], ones:[["ì‹œê°„ ë¶€ì¡±",1]]},
  Q2:{labels:["ì£¼ì–´ì§„ ì¼ì— ì§‘ì¤‘","ë¶„ìœ„ê¸° ì¡°ì„± ë„ì›€","ì£¼ë„ì ìœ¼ë¡œ ì´ë”","ì „ë¬¸ì„±","ë¦¬ë”ì‹­"], values:[16,12,5,5,4]},
  Q3:{labels:["ê· í˜• ì¡íŒ íŒ€","ììœ¨ì ì¸ íŒ€","ì˜ì‚¬ì†Œí†µì´ ì˜ ë˜ëŠ” íŒ€","ì „ë¬¸ê°€ íŒ€","ê°ì ì—­í•  ì˜ ìˆ˜í–‰"], values:[25,7,3,1,1]},
  Q4:{labels:["í˜‘ì—… ëŠ¥ë ¥","ì†Œí†µ ëŠ¥ë ¥","ê¸°ìˆ ë ¥"], values:[8,7,6], others:[["ì±…ì„ê°",2],["ì°½ì˜ì„±",1]]},
  Q5:{labels:["ë§Œ 26ì„¸~30ì„¸","ë§Œ 31ì„¸~35ì„¸","ë§Œ 36ì„¸ ì´ìƒ","ë§Œ 25ì„¸ ì´í•˜"], values:[12,10,6,6]},
  unused: [] // [{q:"ì§ˆë¬¸", items:[[ë‹µ,ìˆ˜],...]}]
};

/* ì°¨íŠ¸ ìƒì„± */
function makeDoughnut(ctx, labels, values){
  return new Chart(ctx,{
    type:'doughnut',
    data:{labels, datasets:[{data:values, backgroundColor:colors}]},
    options:{
      responsive:true, maintainAspectRatio:false, cutout:'55%',
      plugins:{ legend:{position:'top',labels:{color:'#fff'}},
        datalabels:{color:'#fff',font:{weight:'700'},formatter:v=>v}}
    }
  });
}
function makeBarY(ctx, labels, values){
  return new Chart(ctx,{
    type:'bar',
    data:{labels, datasets:[{data:values,backgroundColor:colors}]},
    options:{
      indexAxis:'y', responsive:true, maintainAspectRatio:false,
      scales:{ x:{ticks:{display:false},grid:{color:'#2a2d32'}},
               y:{ticks:{color:'#e2e2e2'},grid:{color:'#222'}}},
      plugins:{ legend:{display:false},
        datalabels:{color:'#fff',anchor:'end',align:'right',formatter:v=>v}}
    }
  });
}
function destroyAll(){ for(const k in charts){ charts[k].destroy(); } charts={}; }
function applyCharts(showAlert=false){
  destroyAll();
  charts.q1 = makeDoughnut(document.getElementById('q1'), datasets.Q1.labels, datasets.Q1.values);
  charts.q2 = makeBarY(document.getElementById('q2'), datasets.Q2.labels, datasets.Q2.values);
  charts.q3 = makeDoughnut(document.getElementById('q3'), datasets.Q3.labels, datasets.Q3.values);
  charts.q4 = makeBarY(document.getElementById('q4'), datasets.Q4.labels, datasets.Q4.values);
  charts.q5 = makeDoughnut(document.getElementById('q5'), datasets.Q5.labels, datasets.Q5.values);
  renderAppendix();
  if(showAlert) alert("ì ìš© ì™„ë£Œ");
}
window.addEventListener('DOMContentLoaded', ()=>applyCharts(false));

/* TXT â†’ ë³´ê³ ì„œ */
function applyTxt(){
  const f=document.getElementById('txt').files[0];
  if(!f){ alert("TXT íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”."); return; }
  const rd=new FileReader();
  rd.onload=()=> {
    const text = String(rd.result||"").trim();
    if(!text){ document.getElementById('report').textContent="ë¹ˆ íŒŒì¼ì…ë‹ˆë‹¤."; return; }
    const lines = text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const bullets = lines.filter(l=>/^[-*â€¢\d]+\s/.test(l));
    const paras = lines.filter(l=>!/^[-*â€¢\d]+\s/.test(l));
    let html = "";
    if(paras.length){ html += `<p>${paras.join("</p><p>")}</p>`; }
    if(bullets.length){
      html += "<ul>";
      bullets.forEach(b=>html += `<li>${b.replace(/^[-*â€¢\d]+\s/, "")}</li>`);
      html += "</ul>";
    }
    document.getElementById('report').innerHTML = html || "ë‚´ìš©ì„ í•´ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
  };
  rd.readAsText(f, 'utf-8');
}

/* CSV â†’ ë°ì´í„°ì…‹ + ë¯¸ì‚¬ìš©/ë¯¸ë§¤í•‘ ìˆ˜ì§‘ */
const COLS = {
  Q1:["Q. ë¦¬ë”ê°€ ëœë‹¤ë©´ ê°€ì¥ ê±±ì •ë˜ëŠ” ë¶€ë¶„ì€?"],
  Q2:["Q. ì„ í˜¸í•˜ëŠ” íŒ€ì›ì˜ ìœ í˜•ì€?"],
  Q3:["Q. ì´ìƒì ì¸ íŒ€ êµ¬ì„±ì€?","Q. ì´ìƒì ì¸ íŒ€ êµ¬ì„±ì€? "],
  Q4:["Q.  íŒ€í”Œë¡œ ì„±ì¥í–ˆë‹¤ê³  ëŠë¼ëŠ” ë¶€ë¶„ì€?"],
  Q5:["Q. ì—°ë ¹ëŒ€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”."]
};
const ALL_KNOWN = new Set([...COLS.Q1,...COLS.Q2,...COLS.Q3,...COLS.Q4,...COLS.Q5]);
function pickCol(row, keys){ for(const k of keys){ if (k in row) return k; } return null; }
function normalizeQ4(s){
  const t=(s||"").replace(/\s+/g,"");
  if(t.includes("í˜‘ì—…")) return "í˜‘ì—… ëŠ¥ë ¥";
  if(t.includes("ì†Œí†µ")) return "ì†Œí†µ ëŠ¥ë ¥";
  return s||"ê¸°íƒ€";
}
function handleCSV(){
  const f=document.getElementById('csv').files[0];
  if(!f){ alert("CSV íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”."); return; }
  Papa.parse(f,{header:true,skipEmptyLines:true,complete:({data})=>{
    const map={Q1:{},Q2:{},Q3:{},Q4:{},Q5:{}, unused:{}};
    data.forEach(r=>{
      const c1=pickCol(r,COLS.Q1), c2=pickCol(r,COLS.Q2), c3=pickCol(r,COLS.Q3),
            c4=pickCol(r,COLS.Q4), c5=pickCol(r,COLS.Q5);

      if(c1 && r[c1]) map.Q1[r[c1]]=(map.Q1[r[c1]]||0)+1;
      if(c2 && r[c2]) map.Q2[r[c2]]=(map.Q2[r[c2]]||0)+1;
      if(c3 && r[c3]) map.Q3[r[c3]]=(map.Q3[r[c3]]||0)+1;
      if(c4){ const v=normalizeQ4(r[c4]); map.Q4[v]=(map.Q4[v]||0)+1; }
      if(c5 && r[c5]) map.Q5[r[c5]]=(map.Q5[r[c5]]||0)+1;

      // ë¯¸ì‚¬ìš©/ë¯¸ë§¤í•‘ Q ìˆ˜ì§‘: "Q"ë¡œ ì‹œì‘í•˜ì§€ë§Œ ì•Œë ¤ì§„ ì—´ì´ ì•„ë‹Œ ê²½ìš°
      Object.keys(r).forEach(k=>{
        const nk = k.trim();
        if (/^Q[.\s]/.test(nk) && !ALL_KNOWN.has(nk)) {
          const ans = (r[k]||"").toString().trim();
          if(!ans) return;
          map.unused[nk] = map.unused[nk] || {};
          map.unused[nk][ans] = (map.unused[nk][ans]||0)+1;
        }
      });
    });

    // Q1: ê°’>=2, 1ì€ ë¶€ë¡
    const q1Ent=Object.entries(map.Q1||{});
    const q1Main=q1Ent.filter(([,v])=>v>=2);
    const q1Ones=q1Ent.filter(([,v])=>v===1);
    datasets.Q1={labels:q1Main.map(([k])=>k), values:q1Main.map(([,v])=>v), ones:q1Ones};

    // Q2: ìƒìœ„ 5
    const q2Top=Object.entries(map.Q2||{}).sort((a,b)=>b[1]-a[1]).slice(0,5);
    datasets.Q2={labels:q2Top.map(([k])=>k), values:q2Top.map(([,v])=>v)};

    // Q3: ê·¸ëŒ€ë¡œ
    const q3=Object.entries(map.Q3||{});
    datasets.Q3={labels:q3.map(([k])=>k), values:q3.map(([,v])=>v)};

    // Q4: ìƒìœ„ 5, ë‚˜ë¨¸ì§€ëŠ” ë¶€ë¡
    const q4Sorted=Object.entries(map.Q4||{}).sort((a,b)=>b[1]-a[1]);
    const q4Top=q4Sorted.slice(0,5);
    const q4Others=q4Sorted.slice(5);
    datasets.Q4={labels:q4Top.map(([k])=>k), values:q4Top.map(([,v])=>v), others:q4Others};

    // Q5: ê·¸ëŒ€ë¡œ
    const q5=Object.entries(map.Q5||{});
    datasets.Q5={labels:q5.map(([k])=>k), values:q5.map(([,v])=>v)};

    // ë¯¸ì‚¬ìš©/ë¯¸ë§¤í•‘
    datasets.unused = Object.entries(map.unused||{}).map(([q,ansMap])=>{
      const items = Object.entries(ansMap).sort((a,b)=>b[1]-a[1]);
      return {q, items};
    });

    alert("CSV ë°ì´í„° ë°˜ì˜ ì™„ë£Œ. 3í˜ì´ì§€ì—ì„œ ìë¬¼ì‡ ë¡œ 'ì ìš©' ì‹¤í–‰í•˜ì„¸ìš”.");
  }});
}

/* ë¶€ë¡ ì±„ìš°ê¸° */
function renderAppendix(){
  // Q1=1
  const q1 = datasets.Q1.ones||[];
  document.getElementById('apx_q1').innerHTML = q1.length
    ? `<table><tr><th>í•­ëª©</th><th>ê°’</th></tr>${q1.map(([k,v])=>`<tr><td>${k}</td><td>${v}</td></tr>`).join("")}</table>`
    : '<span class="muted">ì—†ìŒ</span>';

  // Q4 others
  const q4 = datasets.Q4.others||[];
  document.getElementById('apx_q4').innerHTML = q4.length
    ? `<table><tr><th>í•­ëª©</th><th>ê°’</th></tr>${q4.map(([k,v])=>`<tr><td>${k}</td><td>${v}</td></tr>`).join("")}</table>`
    : '<span class="muted">ì—†ìŒ</span>';

  // ë¯¸ì‚¬ìš©/ë¯¸ë§¤í•‘ Q
  const unused = datasets.unused||[];
  if(!unused.length){
    document.getElementById('apx_unused').innerHTML = '<span class="muted">ì—†ìŒ</span>';
  }else{
    const blocks = unused.map(({q,items})=>{
      const rows = items.map(([a,c])=>`<tr><td>${a}</td><td>${c}</td></tr>`).join("");
      return `<div style="margin-bottom:10px"><div class="muted" style="margin-bottom:4px">â€¢ ${q}</div>
              <table><tr><th>ë‹µë³€</th><th>ê°’</th></tr>${rows}</table></div>`;
    }).join("");
    document.getElementById('apx_unused').innerHTML = blocks;
  }
}
</script>
</body>
</html>
